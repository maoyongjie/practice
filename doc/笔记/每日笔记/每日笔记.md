# 每日笔记

# 1.ES条件删除

**2022-03-17**

```java
	/**
     * 条件删除
     */
    public static long deleteQuery() {
        RestHighLevelClient client = getClient();
        //参数为索引名，可以不指定，可以一个，可以多个
        DeleteByQueryRequest request = new DeleteByQueryRequest("hockey");
        // 更新时版本冲突
        request.setConflicts("proceed");
        // 设置查询条件，第一个参数是字段名，第二个参数是字段的值
        request.setQuery(new TermQueryBuilder("first", "sam"));
        // 更新最大文档数
        request.setSize(10);
        // 批次大小
        request.setBatchSize(1000);
        // 并行
        request.setSlices(2);
        // 使用滚动参数来控制“搜索上下文”存活的时间
        request.setScroll(TimeValue.timeValueMinutes(10));
        // 超时
        request.setTimeout(TimeValue.timeValueMinutes(2));
        // 刷新索引
        request.setRefresh(true);
        try {
            BulkByScrollResponse response = client.deleteByQuery(request, RequestOptions.DEFAULT);
            return response.getStatus().getUpdated();
        } catch (IOException e) {
            e.printStackTrace();
        }finally {
            try {
                client.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return -1;
    }
```

# 2.ES聚合查询

### 2.1 Value Count Aggregation计数存在该字段的记录

```java
ValueCountAggregationBuilder count = AggregationBuilders.count("ErrorTimeCount").field("ErrorTime");

ParsedValueCount bucket = response.getAggregations().get("ErrorTimeCount");
long count = bucket.getValue(); //计数
```

### 2.2 脚本查询组合字段重复查询

```java
TermsAggregationBuilder callTypeTeamAgg = AggregationBuilders
                .terms("compositeQuery")
                .script(aggregateScript(filedList))
                .minDocCount(2);  

private Script aggregateScript(List<String> list) {
        StringBuilder sc = new StringBuilder();
        for (int i = 0; i < list.size(); i++) {
            sc.append(StrUtil.format("doc['{}'].value", list.get(i)));
            if (i != list.size() - 1) {
                sc.append("+'-split-'+");
            }
        }
        return new Script(INLINE, Script.DEFAULT_SCRIPT_LANG, sc.toString(), new HashMap<>(1));
    }
```

### 2.3 Avg Aggregation与Missing字段

统计 exams 索引中考试的平均分数，如未存在分数，默认为 60 分，查询语句如下：

```json
GET /exams/_search?size=0
{
  "aggs" : {
    "avg_grade" : { 
      "avg" : { 
        "field" : "grade",
        "missing": 60
      } 
    }
  }
}
```

**如果指定字段没有值，可以通过 missing 指定默认值；若未指定默认值，缺失该字段值的文档将被忽略（计算）**。

### 2.4 Cardinality Aggregation 去重计数

Cardinality Aggregation 用于基数统计，其作用是先执行类似 SQL 中的 distinct 操作，去掉集合中的重复项，然后统计排重后的集合长度。

**假设 title 字段为文本类型（text），去重时需要指定 keyword，表示把 title 作为整体去重，即不分词统计**。

例如，在 books 索引中对 language 字段进行 cardinality 操作可以统计出编程语言的种类数，查询语句如下：

```json
GET /books/_search?size=0
{
  "aggs" : {
    "all_lan" : { 
      "cardinality" : { "field" : "language" } 
    },
    "title_cnt" : { 
      "cardinality" : { "field" : "title.keyword" } 
    }
  }
}
```

